<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="description" content="D3 example project">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Infovis</title>

  <script src="lib/d3.js"></script>

</head>

<body>

  <script>
    // global data var
    var data;

    var fileName = 'data/FAOSTAT_data.json';

    loadJSON(function (response) {
      // Parse JSON string into object
      data = JSON.parse(response);

      // call drawing functions
      draw();
    });

    /**
     * load data
     */
    function loadJSON(callback) {
      var xobj = new XMLHttpRequest();
      xobj.overrideMimeType("application/json");
      xobj.open('GET', fileName, true);
      xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200") {
          // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
          callback(xobj.responseText);
        }
      };
      xobj.send(null);
    }

    /**
     * make data hierarchical
     */
    function groupData(flatData, key, value) {
      var result = [];
      var hierarchy = {};

      flatData.forEach(function (node) {
        hierarchy[node[key]] = node;
      });

      Object.keys(hierarchy).forEach(function (root) {
        var parent = {};
        parent[key] = root;
        parent[value] = [];
        flatData.forEach(function (node) {
          if (node[key] === root) {
            parent[value].push(node);
            delete node[key];
          }
        });
        result.push(parent);
      });

      return result;
    } 

    /**
     * prepare hierarchical data structure
     */
    function prepareData() {
     var groupRegions = groupData(data, 'Region', 'Countries');
      groupRegions.forEach(function (region) {
        var groupedCountries = groupData(region.Countries, 'Area', 'Years');
        region.Countries = groupedCountries;
        groupedCountries.forEach(function (country) {
          var groupedYears = groupData(country.Years, 'Year', 'Properties');
          country.Years = groupedYears;
        });
      });
      return groupRegions;
    }

    /**
     * create the visualisation
     */
    function draw() {
      var preparedData = prepareData();

      var greeting = '<pre>There are ' + preparedData.length + ' regions. ';
      preparedData.forEach(function (region) {
        greeting += region.Region + ' has ' + region.Countries.length + ' countries. ';
      });
      greeting += '</pre>';
      document.body.innerHTML = greeting;     

      console.log(preparedData); 
    }

  </script>

</body>

</html>
